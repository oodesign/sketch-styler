'use strict';

exports.__esModule = true;
exports.sketchtoolRunCommand = sketchtoolRunCommand;
exports.default = WebpackShellPlugin;

var _getSketchPath = require('@skpm/internal-utils/get-sketch-path');

var _getSketchPath2 = _interopRequireDefault(_getSketchPath);

var _exec = require('@skpm/internal-utils/exec');

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function sketchtoolRunCommand(output, commandIdentifier, options = {}) {
  let command = '';

  if (options.pre) {
    command += options.pre;
    command += ' ';
  }

  command += `"${(0, _getSketchPath2.default)(options.app || process.env.SKETCH_PATH)}/Contents/Resources/sketchtool/bin/sketchtool" run "${output}" "${commandIdentifier}"`;

  if (options.withoutActivating) {
    command += ' --without-activating';
  }

  if (options.waitForExit) {
    command += ' --wait-for-exit';
  }

  if (options.context) {
    command += ` --context="${JSON.stringify(options.context)}"`;
  }

  if (options.post) {
    command += ' ';
    command += options.post;
  }

  if (options.handleError === false) {
    return command;
  }

  const handleError =
  // check if the run command doesn't exist
  'if (echo "$res" | grep "Unknown command ‘run’"); then ' + 'echo "Only available on Sketch 43+"; ' +
  // check if we can't find sketch
  'elif (echo "$res" | grep "such file or directory"); then ' + 'echo "Looks like we can\'t find Sketch.app.\\nYou can specify where to look for it by running:\\n\\necho \\"sketchPath: ABSOLUTE/PATH/TO/Sketch.app\\" > ~/.skpmrc"; ' +
  // not sure why else doesn't work
  'elif (true); then ' + 'echo "$res"; ' + 'fi';

  // run the command and redirect the stderr to stdout so that we can check against it
  return `res=$(${command} 2>&1); ${handleError}`;
}

function WebpackShellPlugin(options) {
  return {
    apply(compiler) {
      compiler.hooks.afterEmit.tapPromise('Run Sketch Command', () => {
        if (!options.script) {
          return Promise.resolve();
        }
        return (0, _exec.exec)(options.script, {
          shell: '/bin/bash',
          maxBuffer: 1024 * 1000 // 1mb
        }).then(res => {
          if (res.stderr) {
            console.error(res.stderr);
          }
          if (res.stdout.trim().length > 0) {
            res.stdout.trim().split('\n').forEach(line => {
              console.log(line);
            });
          }
        }).catch(err => {
          console.error(`${_chalk2.default.red('error')} Error while running the command after build`);
          console.error(err);
          throw err;
        });
      });
    }
  };
}